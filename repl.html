<!doctype html>
<html>
  <head>
    <title>teslo</title>
    <link rel="stylesheet" href="style.css" type="text/css" media="screen" />
  </head>
  <body>
    <h1><a href="./">teslo</a></h1>
    <div id="container">
      <div id="out"></div>
      <form>
        <input id="in" autocomplete="off" />
        <input class="hidden" type="submit" />
      </form>
      <div id="env"></div>
    </div>
    <script type="text/javascript" src="node_modules/cromp/cromp.js"></script>
    <script type="text/javascript" src="teslo.js"></script>
    <script type="text/javascript" src="lib-js/teslo.prelude.js"></script>
    <script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script type="text/javascript">
      (function () {

        var $in = $("#in");
        var $out = $("#out");
        var $form = $("form");
        var $env = $("#env");
        var history = [];
        var historyIndex = 0;
        var env = teslo.environment();
        teslo.evaluate(teslo.prelude, env);

        function read () {
          var line = $in.val();
          $in.val("");
          return line; }

        function eval (line) {
          function evaluateLine () {
            var result = teslo.evaluate(line, env)[0];
            if (result) {
              env.def("$" + history.length, result);
              return teslo.evaluate("(string $" + history.length + ")", env)[0]; } }

           try {
             return evaluateLine();
           } catch (e) {
             return e; } }

        function print (result, cssClass, prefix) {
          $out.append($("<div>")
              .addClass(cssClass)
              .text((prefix || "") + result)); }

        function displayEnvironment () {
          $env.empty();
          Object.keys(env.frames[0])
            .sort()
            .map(function (n) {
              $env.append($("<div>").text(n + " " + teslo.evaluate("(string " + n + ")", env)[0])) }); }

        $form.submit(function () {
          var line = read();
          if (line) {
            history.push(line);
            historyIndex = history.length;
            print(line, "in", "> ");
            var result = eval(line);
            print(result, result instanceof Error ? "error" : "out");
            displayEnvironment(); }
          $out.scrollTop($out[0].scrollHeight);
          return false; });

        $form.keyup(function (e) {
          var key = e.keyCode || e.which;
          if (key === 38 && historyIndex > 0) { // up
            historyIndex--;
            $in.val(history[historyIndex]); }
          if (key === 40 && historyIndex < history.length) { // down
            historyIndex++;
            $in.val(history[historyIndex]); } });

        displayEnvironment();

      })();
    </script>
  </body>
</html>
